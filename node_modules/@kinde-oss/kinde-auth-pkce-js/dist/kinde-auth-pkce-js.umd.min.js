!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).createKindeClient=t()}(this,(function(){"use strict";const e="pkce-code-verifier";async function t(e){const t=await function(e){const t=(new TextEncoder).encode(e);return window.crypto.subtle.digest("SHA-256",t)}(e);return r=t,btoa(String.fromCharCode.apply(null,new Uint8Array(r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");var r}function r(){const e=new Uint32Array(28);return window.crypto.getRandomValues(e),Array.from(e,(e=>("0"+e.toString(16)).substr(-2))).join("")}const o=e=>{try{return JSON.parse(atob(e.split(".")[1]))}catch(e){return null}};return async n=>{const a=(()=>{let e={};return{reset:()=>{e={}},getItem:t=>e[t],removeItem:t=>{delete e[t]},setItem:(t,r)=>{e[t]=r}}})();if(!n)throw Error("Please provide your Kinde credentials");if(n!==Object(n))throw Error("The Kinde SDK must be initiated with an object");const{audience:i,client_id:s,domain:c,is_dangerously_use_local_storage:d=!1,redirect_uri:l,logout_uri:_=l,on_redirect_callback:u,scope:g="openid profile email offline"}=n;if(i&&"string"!=typeof i)throw Error("Please supply a valid audience for your api");if(g&&"string"!=typeof g)throw Error("Please supply a valid scope");if(!l||"string"!=typeof n.redirect_uri)throw Error("Please supply a valid redirect_uri for your users to be redirected after successful authentication");if(!c||"string"!=typeof c)throw Error("Please supply a valid Kinde domain so we can connect to your account");if("boolean"!=typeof d)throw TypeError("Please supply a boolean value for is_dangerously_use_local_storage");const p=s||"spa@live",f={audience:i,client_id:p,redirect_uri:l,authorization_endpoint:`${c}/oauth2/auth`,token_endpoint:`${c}/oauth2/token`,requested_scopes:g,domain:c},m=e=>{if(!e)return;const t=o(e.access_token),r=o(e.id_token);a.setItem("kinde_token",e),a.setItem("kinde_access_token",t),a.setItem("kinde_id_token",r),a.setItem("user",{id:r.sub,given_name:r.given_name,family_name:r.family_name,email:r.email}),d?localStorage.setItem("kinde_refresh_token",e.refresh_token):a.setItem("kinde_refresh_token",e.refresh_token)},h=async()=>{const e=d?localStorage.getItem("kinde_refresh_token"):a.getItem("kinde_refresh_token");if(e)try{const t=await fetch(f.token_endpoint,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"}),body:new URLSearchParams({client_id:f.client_id,grant_type:"refresh_token",refresh_token:e})}),r=await t.json();return m(r),r.access_token}catch(e){console.error(e)}},w=(e,t="kinde_access_token")=>{const r=a.getItem(t);return r?r[e]:null},y=async o=>{const{app_state:n,start_page:a,is_create_org:s,org_id:c,org_name:d="",org_code:_}=o,{state:u,code_challenge:g,url:m}=await(async(o,n)=>{const a=r(),i=r(),s=await t(i);return sessionStorage.setItem(`${e}-${a}`,JSON.stringify({codeVerifier:i,appState:n})),{state:a,code_challenge:s,url:new URL(o)}})(f.authorization_endpoint,n);let h={redirect_uri:l,client_id:p,response_type:"code",scope:f.requested_scopes,code_challenge:g,code_challenge_method:"S256",state:u,start_page:a};i&&(h.audience=i),_&&(h.org_code=_),s&&(h.is_create_org=s,h.org_name=d),c&&(h.org_id=c),m.search=new URLSearchParams(h),window.location=m},k=()=>a.getItem("user");return await(async()=>{const t=new URLSearchParams(window.location.search);if(t.has("code"))await(async t=>{const r=t.get("code"),o=t.get("state"),n=t.get("error");n&&console.error(`Error returned from authorization server: ${n}`);const a=sessionStorage.getItem(`${e}-${o}`);if(a){const{appState:t,codeVerifier:n}=JSON.parse(a);try{const a=await fetch(f.token_endpoint,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"}),body:new URLSearchParams({client_id:f.client_id,code:r,code_verifier:n,grant_type:"authorization_code",redirect_uri:f.redirect_uri})}),i=await a.json();m(i);const s=new URL(window.location);s.search="",sessionStorage.removeItem(`${e}-${o}`);const c=k();window.history.pushState({},"",s),u&&u(c,t)}catch(t){console.error(t),sessionStorage.removeItem(`${e}-${o}`)}}else console.error("Invalid state")})(t);else if(d){await h();const e=k();u&&u(e)}})(),{getToken:async()=>{const e=a.getItem("kinde_token");if(!e)return await h();const t=a.getItem("kinde_access_token"),r=Math.floor(Date.now()/1e3);return t.exp>r?e.access_token:await h()},getUser:k,login:async e=>{await y({...e})},logout:async()=>{const e=new URL(`${f.domain}/logout`);try{a.reset(),d&&localStorage.removeItem("kinde_refresh_token"),e.search=new URLSearchParams({redirect:_}),window.location=e}catch(e){console.error(e)}},register:async e=>{await y({...e,start_page:"registration"})},createOrg:async e=>{await y({...e,start_page:"registration",is_create_org:!0})},getClaim:w,getPermissions:()=>{const e=w("org_code");return{permissions:w("permissions"),orgCode:e}},getPermission:e=>{const t=w("org_code");return{isGranted:(w("permissions")||[]).some((t=>t===e)),orgCode:t}},getOrganization:()=>({orgCode:w("org_code")}),getUserOrganizations:()=>({orgCodes:w("org_codes","kinde_id_token")})}}}));
